// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ===================== Enums =====================
 */

enum ScopeType {
  oidc // contoh: openid, email, profile, offline_access
  app // contoh: subscription.read, model.read
}

enum ScopeKind {
  scope // granular: "subscription.read"
  superScope // wildcard: "subscription" (cover "subscription.*")
}

/**
 * ===================== Models =====================
 */

model users {
  id                           String                   @id @default(cuid())
  fullName                     String
  username                     String                   @unique
  email                        String                   @unique
  passwordHash                 String
  sessionVersion               Int                      @default(1) // bump untuk tendang semua sesi user
  createdAt                    DateTime                 @default(now()) @db.Timestamptz(3)
  updatedAt                    DateTime                 @updatedAt @db.Timestamptz(3)
  roleId                       String?
  role                         roles?                   @relation(fields: [roleId], references: [id], onDelete: SetNull)
  metaData                     Json?
  // relations
  sessions                     sessions[]
  userScopes                   user_scopes[] // (opsional) grant langsung di luar role
  technitian_members           technitian_team_member[]
  installed_subscriptions      subscriptions[]          @relation("InstallationByUser")
  created_subscriptions        subscriptions[]          @relation("Creator")
  handled_ticket_subscriptions ticket_subscription[]    @relation("HandledTickets")

  // opposite relations for ticket submitters
  submitted_ticket_subscriptions ticket_subscription[] @relation("SubmittedTickets")
  submitted_ticket_sites         ticket_site[]         @relation("SubmittedSiteTickets")

  submitted_site_ticket_details ticket_site_detail[] @relation("SolvedByUser")
}

model roles {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime @updatedAt @db.Timestamptz(3)

  // relations
  roleScopes role_scopes[]
  users      users[]
}

model scopes {
  id          String   @id @default(cuid())
  name        String   @unique // "subscription.read"
  description String?
  createdAt   DateTime @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime @updatedAt @db.Timestamptz(3)

  // relations
  roleScopes role_scopes[]
  userScopes user_scopes[]
}

/**
 * --------- Pivot Tables ---------
 */

// Role ↔ Scope
model role_scopes {
  roleId  String
  scopeId String

  role  roles  @relation(fields: [roleId], references: [id], onDelete: Cascade)
  scope scopes @relation(fields: [scopeId], references: [id], onDelete: Cascade)

  @@id([roleId, scopeId])
  @@index([roleId])
  @@index([scopeId])
}

// (Opsional) User ↔ Scope (grant langsung/override)
model user_scopes {
  userId  String
  scopeId String

  user  users  @relation(fields: [userId], references: [id], onDelete: Cascade)
  scope scopes @relation(fields: [scopeId], references: [id], onDelete: Cascade)

  @@id([userId, scopeId])
  @@index([userId])
  @@index([scopeId])
}

model sessions {
  id             String    @id @default(cuid())
  sid            String    @unique // UUID (string)
  userId         String
  userAgent      String?
  ipAddr         String? // simpan IP sebagai string
  createdAt      DateTime  @default(now()) @db.Timestamptz(3)
  lastSeenAt     DateTime  @default(now()) @db.Timestamptz(3)
  expiresAt      DateTime // TTL absolut (mis. now()+15m) @db.Timestamptz(3)
  revokedAt      DateTime? @db.Timestamptz(3)
  sessionVersion Int // snapshot dari users.sessionVersion saat login

  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sid])
  @@index([userId, revokedAt, expiresAt]) // query sesi aktif user
}

// endof auth models

model customers {
  id         String  @id @default(cuid())
  name       String
  email      String?
  phone      String?
  address    String?
  ktp_number String?
  ktp_photo  String?
  password   String?

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  // relations
  subscriptions        subscriptions[]
  invoices             invoice[]
  ticket_subscriptions ticket_subscription[]

  @@index([name])
}

model services {
  id         String   @id @default(cuid())
  name       String
  price      Float
  speed      Float
  created_at DateTime @default(now()) @db.Timestamptz(3)
  discount   Float    @default(0)
  is_active  Boolean  @default(true)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  // relations
  subscriptions subscriptions[]

  @@index([name])
}

model subscriptions {
  id String @id @default(cuid())

  // link to customer and service entities (normalized)
  customer_id String
  customer    customers @relation(fields: [customer_id], references: [id])

  service_id String
  service    services @relation(fields: [service_id], references: [id])

  // address fields
  province       String? // province
  kabupaten_kota String? // regency or city (same administrative level; provide one)
  kecamatan      String? // district (subdivision of regency/city)
  kelurahan      String? // subdistrict or village (subdivision of district)
  postal_code    String? // postal code

  // device / location fields
  oid_identifier  String?
  serial_number   String?
  vlan            Int?
  vlan_profile    String?
  traffic_profile String?
  onu_number      Int?
  mac_address     String?
  status          String?
  latitude        Float?
  longitude       Float?
  odc_id          String?
  odc             odc?    @relation(fields: [odc_id], references: [id], onDelete: SetNull)
  olt_id          String?
  olt             olt?    @relation(fields: [olt_id], references: [id], onDelete: SetNull)
  odp_id          String?
  odp             odp?    @relation(fields: [odp_id], references: [id], onDelete: SetNull)

  is_static_ip Boolean @default(false)
  ip_address   String?
  odp_distance Int?

  // pppoe
  pppoe_username String?
  pppoe_password String?

  home_photo        String?
  location_note     String?
  cpe_photo         String?
  speed_test_photo  String?
  form_installation String?
  description       String?

  onus                 onus[]
  invoices             invoice[]
  invoice_details      invoice_detail[]
  ticket_subscriptions ticket_subscription[]

  installation_date       DateTime?        @db.Timestamptz(3)
  installation_by_team_id String?
  installation_by_team    technitian_team? @relation(fields: [installation_by_team_id], references: [id])
  installation_by_user_id String?
  installation_by_user    users?           @relation("InstallationByUser", fields: [installation_by_user_id], references: [id])
  created_by              String?
  created_by_user         users?           @relation("Creator", fields: [created_by], references: [id], onDelete: SetNull)

  next_invoice_date DateTime? @db.Timestamptz(3)

  created_at DateTime  @default(now()) @db.Timestamptz(3)
  updated_at DateTime  @updatedAt @db.Timestamptz(3)
  deleted_at DateTime? @db.Timestamptz(3)

  @@index([installation_by_team_id])
  @@index([installation_by_user_id])
  @@index([created_by])
  @@index([customer_id])
  @@index([service_id])
  @@index([odc_id])
  @@index([olt_id])
  @@index([odp_id])
}

model onus {
  id              String         @id @default(cuid())
  olt             olt            @relation(fields: [olt_id], references: [id], onDelete: Cascade)
  olt_id          String
  subscription    subscriptions? @relation(fields: [subscription_id], references: [id], onDelete: SetNull)
  subscription_id String?
  oid_identifier  String // kunci konsisten: "OLT/slot-port/onu" atau serial
  serial          String?
  name            String?
  mac_address     String?
  description     String?
  onu_index       Int? // index vendor jika ada

  snmp_values snmp_values[]

  @@unique([olt_id, oid_identifier])
  @@index([olt_id])
  @@index([subscription_id])
  @@index([serial])
}

model snmp_values {
  id         String   @id @default(cuid())
  onu        onus     @relation(fields: [onu_id], references: [id], onDelete: Cascade)
  onu_id     String
  metric_key String
  oid        String
  value      String
  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  @@unique([onu_id, metric_key])
  @@index([onu_id, metric_key, created_at(sort: Desc)])
  @@index([onu_id, created_at(sort: Desc)])
}

/**
 * ========= MAPPING OID (DEFINISI) ========= *
 */

model oid_map {
  id String @id @default(cuid())

  // penanda profile/adapter SNMP yang dipakai OLT
  // contoh: "zte_gpon", "hsgq_epon"
  profile String

  // nama metrik normalisasi (harus sama dengan snmp_value.metric_key)
  // contoh: "gpon.ont.GponName", "gpon.optical.rx", "status"
  metric_key String

  // OID vendor
  oid String

  // opsional: peta nilai enum: {"1":"Enabled","2":"Disabled"} atau reason codes
  values Json?

  // opsional: nama fungsi konversi di kode (mis. "zte_rx", "zte_tx")
  formula String?

  @@unique([profile, metric_key])
}

model olt {
  id              String          @id
  name            String          @db.VarChar(100)
  brand           String?         @db.VarChar(100)
  type            String?         @db.VarChar(100)
  ip_address      String?         @db.VarChar(45)
  username        String?         @db.VarChar(100)
  password        String?         @db.VarChar(100)
  read_community  String?         @db.VarChar(100)
  write_community String?         @db.VarChar(100)
  port_capacity   Int
  latitude        Float?
  longitude       Float?
  odcs            odc[]
  subscriptions   subscriptions[]
  odps            odp[]
  onus            onus[]
  created_at      DateTime        @default(now()) @db.Timestamptz(3)
  updated_at      DateTime        @updatedAt @db.Timestamptz(3)
  vlanC320s       vlan_c320[]
  tcontC320s      tcont_c320[]
  trafficC320s    traffic_c320[]
  uncfgC320s      uncfg_c320[]
}

model odc {
  id            String          @id
  name          String          @db.VarChar(100)
  latitude      Float?
  longitude     Float?
  olt_id        String
  olt           olt             @relation(fields: [olt_id], references: [id])
  port_capacity Int
  subscriptions subscriptions[]
  odps          odp[]
  created_at    DateTime        @default(now()) @db.Timestamptz(3)
  updated_at    DateTime        @updatedAt @db.Timestamptz(3)
}

model odp {
  id            String          @id
  name          String          @db.VarChar(100)
  latitude      Float?
  longitude     Float?
  odc_id        String
  odc           odc             @relation(fields: [odc_id], references: [id])
  olt_id        String
  olt           olt             @relation(fields: [olt_id], references: [id])
  port_capacity Int
  subscriptions subscriptions[]
  created_at    DateTime        @default(now()) @db.Timestamptz(3)
  updated_at    DateTime        @updatedAt @db.Timestamptz(3)
}

model fiber_route {
  id         String   @id
  name       String   @db.VarChar(100)
  polyline   Json[]
  color      String
  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)
}

model invoice {
  id         String @id @default(cuid())
  invoice_no String @unique

  customer_id String
  customer    customers @relation(fields: [customer_id], references: [id])

  total_invoice Int     @default(0)
  has_tax       Boolean @default(false)
  tax           Float   @default(0.11)
  tax_amount    Int     @default(0)
  grand_total   Int     @default(0)

  paid_at        DateTime? @db.Timestamptz(3)
  payment_method String?
  receive_by     String?
  approved_by    String?

  pg_id          String?
  pg_ref         String?
  pg_created     DateTime? @db.Timestamptz(3)
  no_va          String?
  qris           String?
  payment_amount Int?
  status         String?   @default("unpaid")

  description String?

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  payment_proof          String?
  last_invoice_sent_date DateTime? @db.Timestamptz(3)

  subscription_id String?
  subscription    subscriptions? @relation(fields: [subscription_id], references: [id])

  sku             String?
  invoice_details invoice_detail[]

  @@index([customer_id])
  @@index([subscription_id])
  @@index([invoice_no])
}

model invoice_detail {
  id String @id @default(cuid())

  subscription_id String?
  subscription    subscriptions? @relation(fields: [subscription_id], references: [id])

  invoice_no String
  invoice    invoice? @relation(fields: [invoice_no], references: [invoice_no], onUpdate: Cascade, onDelete: Cascade)

  status      String?
  index_month Int?
  date        DateTime? @db.Timestamptz(3)

  billing_name        String
  billing_description String?
  billing_price       Float

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  @@index([invoice_no])
  @@index([subscription_id])
  @@index([index_month])
}

model vendor_tenchnitian {
  id             String   @id @default(cuid())
  company_name   String
  contact_person String?
  email          String?  @db.VarChar(255)
  address        String?
  created_at     DateTime @default(now()) @db.Timestamptz(3)
  updated_at     DateTime @updatedAt @db.Timestamptz(3)
}

model technitian_team {
  id         String   @id @default(cuid())
  name       String
  status     String?  @default("active")
  leader     String?
  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  // relations
  members           technitian_team_member[]
  subscriptions     subscriptions[]
  maintenance_sites ticket_site[]
}

model technitian_team_member {
  member_id String @id @default(cuid())

  team_id String
  team    technitian_team @relation(fields: [team_id], references: [id], onDelete: Cascade)

  user_id String
  user    users  @relation(fields: [user_id], references: [id], onDelete: Cascade)

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  @@index([team_id])
  @@index([user_id])
}

model ticket_subscription {
  ticket_id               String         @id @default(cuid())
  subscription_id         String?
  subscription            subscriptions? @relation(fields: [subscription_id], references: [id], onDelete: Cascade)
  customer_id             String?
  customer                customers?     @relation(fields: [customer_id], references: [id], onDelete: SetNull)
  subject_problem         String
  customer_report         String?
  technician_update_desc  String?
  work_by                 String?
  open_by                 String?
  closed_at               DateTime?      @db.Timestamptz(3)
  created_by              String?
  ticket_close_date       DateTime?      @db.Timestamptz(3)
  status                  String?        @default("Open")
  picture_from_customer   String?
  picture_from_technician String?
  created_at              DateTime       @default(now()) @db.Timestamptz(3)
  updated_at              DateTime       @updatedAt @db.Timestamptz(3)
  submit_by               String?
  submit_by_user          users?         @relation("SubmittedTickets", fields: [submit_by], references: [id], onDelete: SetNull)
  handle_by_team          String?

  // relation for the technician/user who handles the ticket (maps to users.handled_ticket_subscriptions)
  work_by_user users? @relation("HandledTickets", fields: [work_by], references: [id], onDelete: SetNull)

  @@index([subscription_id])
  @@index([customer_id])
  @@index([created_by])
  @@index([submit_by])
  @@index([handle_by_team])
}

model ticket_site {
  mt_site_id         String               @id @default(cuid())
  site_type          String?
  problem_report     String
  problem_picture    String?
  status             String?              @default("Open")
  submit_by          String?
  submit_by_user     users?               @relation("SubmittedSiteTickets", fields: [submit_by], references: [id], onDelete: SetNull)
  handle_by_team     String?
  handle_by_team_rel technitian_team?     @relation(fields: [handle_by_team], references: [id], onDelete: SetNull)
  created_by         String?
  created_at         DateTime             @default(now()) @db.Timestamptz(3)
  updated_at         DateTime             @updatedAt @db.Timestamptz(3)
  ticket_details     ticket_site_detail[]

  @@index([mt_site_id])
  @@index([created_by])
}

model ticket_site_detail {
  maintenance_site_detail_id String       @id @default(cuid())
  mt_site_id                 String?
  mt_site                    ticket_site? @relation(fields: [mt_site_id], references: [mt_site_id], onDelete: Cascade)
  site_id                    String
  solved_picture             String?
  technician_report          String?
  solved_at                  DateTime?    @db.Timestamptz(3)
  solved_by                  String?
  solved_by_user             users?       @relation("SolvedByUser", fields: [solved_by], references: [id], onDelete: SetNull)
  status                     String?      @default("open")
  created_at                 DateTime     @default(now()) @db.Timestamptz(3)
  updated_at                 DateTime     @updatedAt @db.Timestamptz(3)

  @@index([mt_site_id])
  @@index([site_id])
  @@index([solved_by])
}

enum wa_session_status {
  CONNECTING
  OPEN
  CLOSED
  LOGGED_OUT
}

enum wa_key_type {
  PREKEY
  SESSION
  SENDER_KEY
  APP_STATE_SYNC
  IDENTITY
  OTHERS
}

model whatsapp_account {
  id           String              @id @default(cuid())
  label        String?
  phone_number String?             @unique
  is_business  Boolean             @default(false)
  sessions     whatsapp_session[]
  templates    whatsapp_template[]
  created_at   DateTime            @default(now()) @db.Timestamptz(3)
  updated_at   DateTime            @updatedAt @db.Timestamptz(3)
}

model whatsapp_session {
  id                  String                 @id @default(cuid())
  account_id          String?
  account             whatsapp_account?      @relation(fields: [account_id], references: [id])
  name                String                 @unique
  status              wa_session_status      @default(CONNECTING)
  qr_raw              String?
  qr_updated_at       DateTime?              @db.Timestamptz(3)
  connected_at        DateTime?              @db.Timestamptz(3)
  disconnected_at     DateTime?              @db.Timestamptz(3)
  last_conn_update_at DateTime?              @db.Timestamptz(3)
  webhook_url         String?
  meta                Json?
  creds               whatsapp_creds?
  keys                whatsapp_key[]
  logs                whatsapp_message_log[]
  created_at          DateTime               @default(now()) @db.Timestamptz(3)
  updated_at          DateTime               @updatedAt @db.Timestamptz(3)
}

model whatsapp_creds {
  session_id String           @id
  session    whatsapp_session @relation(fields: [session_id], references: [id], onDelete: Cascade)
  data       Json
  version    Int              @default(1)
  created_at DateTime         @default(now()) @db.Timestamptz(3)
  updated_at DateTime         @updatedAt @db.Timestamptz(3)
}

model whatsapp_key {
  id         String           @id @default(cuid())
  session_id String
  session    whatsapp_session @relation(fields: [session_id], references: [id], onDelete: Cascade)
  type       wa_key_type
  key_id     String
  value      Json
  scope      String?

  @@unique([session_id, type, key_id, scope])
  @@index([session_id, type])
  @@index([key_id])
  @@index([scope])
}

enum WhatsappDirection {
  IN
  OUT
}

enum WhatsappMessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  STICKER
  CONTACT
  LOCATION
  BUTTON
  OTHER
}

model whatsapp_message_log {
  id           String              @id @default(cuid())
  session_id   String
  session      whatsapp_session    @relation(fields: [session_id], references: [id], onDelete: Cascade)
  direction    WhatsappDirection // IN | OUT
  jid          String
  from_jid     String
  to_jid       String
  from_number  String?
  to_number    String?
  message_id   String?
  message      Json
  message_type WhatsappMessageType
  status       String?
  error        String?
  created_at   DateTime            @default(now()) @db.Timestamptz(3)

  @@index([session_id, created_at])
  @@index([jid])
  @@index([from_number])
  @@index([to_number])
}

model whatsapp_template_variable {
  id          String            @id @default(cuid())
  template_id String
  template    whatsapp_template @relation(fields: [template_id], references: [id], onDelete: Cascade)
  key         String
  label       String?
  description String?
  required    Boolean           @default(true)
  created_at  DateTime          @default(now()) @db.Timestamptz(3)
  updated_at  DateTime          @updatedAt @db.Timestamptz(3)

  @@unique([template_id, key])
  @@index([template_id])
}

model whatsapp_template {
  id           String                       @id @default(cuid())
  code         String                       @unique
  label        String
  body         String
  message_type WhatsappMessageType          @default(TEXT)
  account_id   String?
  account      whatsapp_account?            @relation(fields: [account_id], references: [id], onDelete: SetNull)
  example_vars Json?
  is_active    Boolean                      @default(true)
  variables    whatsapp_template_variable[]
  created_at   DateTime                     @default(now()) @db.Timestamptz(3)
  updated_at   DateTime                     @updatedAt @db.Timestamptz(3)

  @@index([account_id])
  @@index([code])
}

model notification {
  id               String   @id @default(cuid())
  notif_id         String
  notif_identifier String
  loading          Boolean  @default(true)
  status           Boolean  @default(false)
  title            String
  message          String
  category         String?
  link             String?
  created_at       DateTime @default(now()) @db.Timestamptz(3)
  updated_at       DateTime @updatedAt @db.Timestamptz(3)
}

model vlan_c320 {
  id           String   @id @default(cuid())
  olt_id       String
  olt          olt      @relation(fields: [olt_id], references: [id], onDelete: Cascade)
  profile_name String
  tag_mode     String
  vlan         Int
  created_at   DateTime @default(now()) @db.Timestamptz(3)
  updated_at   DateTime @updatedAt @db.Timestamptz(3)
}

model tcont_c320 {
  id           String   @id @default(cuid())
  olt_id       String
  olt          olt      @relation(fields: [olt_id], references: [id], onDelete: Cascade)
  profile_name String
  fbw          Int
  abw          Int
  mbw          Int
  type         String
  created_at   DateTime @default(now()) @db.Timestamptz(3)
  updated_at   DateTime @updatedAt @db.Timestamptz(3)
}

model traffic_c320 {
  id           String   @id @default(cuid())
  olt_id       String
  olt          olt      @relation(fields: [olt_id], references: [id], onDelete: Cascade)
  profile_name String
  sir          Int
  pir          Int
  cbs          String
  pbs          String
  created_at   DateTime @default(now()) @db.Timestamptz(3)
  updated_at   DateTime @updatedAt @db.Timestamptz(3)
}

model uncfg_c320 {
  id            String   @id @default(cuid())
  olt_id        String
  olt           olt      @relation(fields: [olt_id], references: [id], onDelete: Cascade)
  onu_index     String
  serial_number String
  created_at    DateTime @default(now()) @db.Timestamptz(3)
  updated_at    DateTime @updatedAt @db.Timestamptz(3)

  @@unique([onu_index, olt_id], name: "onu_index_olt_id")
}

model http_log {
  id         String   @id @default(cuid())
  method     String
  url        String
  headers    Json?
  body       String?
  response   String?
  status     Int?
  error      String?
  created_at DateTime @default(now()) @db.Timestamptz(3)
}
